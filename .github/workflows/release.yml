# Void å‘å¸ƒå·¥ä½œæµ
# ç”¨äºç¼–è¯‘ Void ç¼–è¾‘å™¨å¹¶ç”Ÿæˆå¯åˆ†å‘çš„å®‰è£…åŒ…
# åŸºäº void-builder çš„æ„å»ºæµç¨‹ç®€åŒ–è€Œæ¥

name: Release Void

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.99.3)'
        required: true
        type: string
      target_platform:
        description: 'ç›®æ ‡å¹³å°'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - linux
          - macos
          - windows
      create_release:
        description: 'åˆ›å»º GitHub Release'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20.18.2'
  PYTHON_VERSION: '3.11'
  NODE_OPTIONS: '--max-old-space-size=8192'
  APP_NAME: 'Void'
  BINARY_NAME: 'void'

jobs:
  # ====================
  # ç‰ˆæœ¬æ£€æŸ¥ä¸å‡†å¤‡
  # ====================
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: éªŒè¯ç‰ˆæœ¬å·
        id: version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::ç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”ä¸º x.y.z æ ¼å¼"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $VERSION"

  # ====================
  # Linux æ„å»º
  # ====================
  build-linux:
    needs: prepare
    if: ${{ github.event.inputs.target_platform == 'all' || github.event.inputs.target_platform == 'linux' }}
    runs-on: ubuntu-22.04
    timeout-minutes: 90
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£… Linux ä¾èµ–
        run: |
          sudo apt-get update -y
          sudo apt-get install -y \
            build-essential \
            g++ \
            libx11-dev \
            libxkbfile-dev \
            libsecret-1-dev \
            libkrb5-dev \
            python-is-python3 \
            fakeroot \
            rpm \
            dpkg

      - name: å®‰è£…äº¤å‰ç¼–è¯‘å·¥å…·é“¾ (ARM64)
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y \
            g++-aarch64-linux-gnu \
            gcc-aarch64-linux-gnu

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci

      - name: ç¼–è¯‘ React ç»„ä»¶
        run: npm run buildreact

      - name: ç¼–è¯‘é¡¹ç›®
        run: npm run compile

      - name: ç¼–è¯‘æ‰©å±•
        run: npm run compile-extensions-build

      - name: æ„å»º Linux ${{ matrix.arch }} å¯æ‰§è¡Œæ–‡ä»¶
        env:
          npm_config_arch: ${{ matrix.arch }}
        run: npm run gulp vscode-linux-${{ matrix.arch }}

      - name: ç§»åŠ¨å¹¶åˆ›å»º tar.gz å‹ç¼©åŒ…
        run: |
          # ç§»åŠ¨æ„å»ºäº§ç‰©åˆ°å·¥ä½œç›®å½•
          mv ../VSCode-linux-${{ matrix.arch }} ./dist-linux-${{ matrix.arch }}
          # åˆ›å»ºå‹ç¼©åŒ…
          tar -czvf void-linux-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.tar.gz ./dist-linux-${{ matrix.arch }}
          echo "âœ… å·²åˆ›å»ºå‹ç¼©åŒ…: void-linux-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.tar.gz"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: void-linux-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}
          path: ./void-linux-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.tar.gz
          retention-days: 14

  # ====================
  # macOS æ„å»º
  # ====================
  build-macos:
    needs: prepare
    if: ${{ github.event.inputs.target_platform == 'all' || github.event.inputs.target_platform == 'macos' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            runner: macos-14
          - arch: x64
            runner: macos-13
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 90

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci

      - name: ç¼–è¯‘ React ç»„ä»¶
        run: npm run buildreact

      - name: ç¼–è¯‘é¡¹ç›®
        run: npm run compile

      - name: ç¼–è¯‘æ‰©å±•
        run: npm run compile-extensions-build

      - name: æ„å»º macOS ${{ matrix.arch }} å¯æ‰§è¡Œæ–‡ä»¶
        run: npm run gulp vscode-darwin-${{ matrix.arch }}

      - name: ç§»åŠ¨å¹¶åˆ›å»º zip å‹ç¼©åŒ…
        run: |
          # ç§»åŠ¨æ„å»ºäº§ç‰©åˆ°å·¥ä½œç›®å½•
          mv ../VSCode-darwin-${{ matrix.arch }} ./dist-darwin-${{ matrix.arch }}
          # åˆ›å»ºå‹ç¼©åŒ…
          zip -r -y void-darwin-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip ./dist-darwin-${{ matrix.arch }}
          echo "âœ… å·²åˆ›å»ºå‹ç¼©åŒ…: void-darwin-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: void-darwin-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}
          path: ./void-darwin-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip
          retention-days: 14

  # ====================
  # Windows æ„å»º
  # ====================
  build-windows:
    needs: prepare
    if: ${{ github.event.inputs.target_platform == 'all' || github.event.inputs.target_platform == 'windows' }}
    runs-on: windows-2022
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: å®‰è£…é¡¹ç›®ä¾èµ–
        run: npm ci

      - name: ç¼–è¯‘ React ç»„ä»¶
        run: npm run buildreact

      - name: ç¼–è¯‘é¡¹ç›®
        run: npm run compile

      - name: ç¼–è¯‘æ‰©å±•
        run: npm run compile-extensions-build

      - name: æ„å»º Windows ${{ matrix.arch }} å¯æ‰§è¡Œæ–‡ä»¶
        run: npm run gulp vscode-win32-${{ matrix.arch }}

      - name: ç§»åŠ¨å¹¶åˆ›å»º zip å‹ç¼©åŒ…
        shell: pwsh
        run: |
          $folderName = "VSCode-win32-${{ matrix.arch }}"
          $distFolder = "dist-win32-${{ matrix.arch }}"
          $zipName = "void-win32-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip"
          $sourcePath = Join-Path ".." $folderName

          if (Test-Path $sourcePath) {
            # ç§»åŠ¨åˆ°å·¥ä½œç›®å½•
            Move-Item -Path $sourcePath -Destination $distFolder
            # åˆ›å»ºå‹ç¼©åŒ…
            Compress-Archive -Path $distFolder -DestinationPath $zipName -Force
            Write-Host "âœ… å·²åˆ›å»ºå‹ç¼©åŒ…: $zipName"
          } else {
            Write-Error "æ„å»ºäº§ç‰©æ–‡ä»¶å¤¹ä¸å­˜åœ¨: $folderName"
            exit 1
          }

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: void-win32-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}
          path: ./void-win32-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip
          retention-days: 14

  # ====================
  # åˆ›å»º GitHub Release
  # ====================
  release:
    needs: [prepare, build-linux, build-macos, build-windows]
    if: ${{ always() && github.event.inputs.create_release == 'true' && needs.prepare.result == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: åˆ—å‡ºä¸‹è½½çš„äº§ç‰©
        run: |
          echo "ğŸ“¦ ä¸‹è½½çš„æ„å»ºäº§ç‰©:"
          find ./artifacts -type f -name "*.tar.gz" -o -name "*.zip" | sort

      - name: åˆ›å»º Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Void ${{ needs.prepare.outputs.version }}
          body: |
            ## Void ${{ needs.prepare.outputs.version }}

            ### ä¸‹è½½

            | å¹³å° | æ¶æ„ | ä¸‹è½½ |
            |------|------|------|
            | Linux | x64 | `void-linux-x64-${{ needs.prepare.outputs.version }}.tar.gz` |
            | Linux | ARM64 | `void-linux-arm64-${{ needs.prepare.outputs.version }}.tar.gz` |
            | macOS | ARM64 (Apple Silicon) | `void-darwin-arm64-${{ needs.prepare.outputs.version }}.zip` |
            | macOS | x64 (Intel) | `void-darwin-x64-${{ needs.prepare.outputs.version }}.zip` |
            | Windows | x64 | `void-win32-x64-${{ needs.prepare.outputs.version }}.zip` |
            | Windows | ARM64 | `void-win32-arm64-${{ needs.prepare.outputs.version }}.zip` |

            ### å®‰è£…è¯´æ˜

            1. ä¸‹è½½å¯¹åº”å¹³å°çš„å‹ç¼©åŒ…
            2. è§£å‹åˆ°ä»»æ„ç›®å½•
            3. è¿è¡Œ `Void` (macOS/Linux) æˆ– `Void.exe` (Windows)
          draft: true
          generate_release_notes: true
          files: |
            ./artifacts/**/*.tar.gz
            ./artifacts/**/*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
